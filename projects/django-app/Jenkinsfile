pipeline {
    agent {
        kubernetes {
            yaml '''
apiVersion: v1
kind: Pod
metadata:
  labels:
    jenkins/label: jenkins-jenkins-agent
spec:
  serviceAccountName: default

  containers:
    - name: python
      image: python:3.12-slim
      command: ['cat']
      tty: true
      volumeMounts:
        - name: workspace-volume
          mountPath: /home/jenkins/agent

    - name: kaniko
      image: gcr.io/kaniko-project/executor:latest
      command:
        - /busybox/sh
      args:
        - -c
        - "sleep 9999999"
      tty: true
      volumeMounts:
        - name: workspace-volume
          mountPath: /home/jenkins/agent
        - name: kaniko-secret
          mountPath: /kaniko/.docker

    - name: kubectl
      image: bitnami/kubectl:latest
      command: ['cat']
      tty: true
      volumeMounts:
        - name: workspace-volume
          mountPath: /home/jenkins/agent

    - name: helm
      image: alpine/helm:3.15.4
      command: ['cat']
      tty: true
      volumeMounts:
        - name: workspace-volume
          mountPath: /home/jenkins/agent

    - name: jnlp
      image: jenkins/inbound-agent:3355.v388858a_47b_33-12
      args: ['$(JENKINS_SECRET)', '$(JENKINS_NAME)']
      volumeMounts:
        - name: workspace-volume
          mountPath: /home/jenkins/agent

  volumes:
    - name: workspace-volume
      emptyDir: {}

    - name: kaniko-secret
      emptyDir: {}
'''
        }
    }

    environment {
        REGISTRY = "ghcr.io/YOUR_GITHUB_USERNAME"
        IMAGE    = "django-app"
        TAG      = "latest"

        BLUE_RELEASE  = "django-blue"
        GREEN_RELEASE = "django-green"

        HOST = "django.local"

        COVERAGE_FAIL_UNDER = "80"
    }

    stages {

        stage('Checkout') {
            steps { checkout scm }
        }

        stage('Run Unit Tests (pytest + coverage)') {
            steps {
                container('python') {
                    sh '''
                        set -e
                        export PYTHONPATH=$PYTHONPATH:$(pwd)/projects/django-app
                        pip install -r projects/django-app/requirements.txt
                        coverage run -m pytest
                        coverage report --fail-under=$COVERAGE_FAIL_UNDER
                    '''
                }
            }
        }

        stage('Build image (Kaniko)') {
            steps {
                container('kaniko') {
                    withCredentials([string(credentialsId: 'ghcr-pat', variable: 'GHCR_PAT')]) {
                        sh '''
                            set -e

                            # Write GHCR auth file for Kaniko
                            mkdir -p /kaniko/.docker
                            cat <<EOF > /kaniko/.docker/config.json
                            {
                              "auths": {
                                "ghcr.io": {
                                  "auth": "$(echo -n ${REGISTRY#*/}:$GHCR_PAT | base64)"
                                }
                              }
                            }
EOF

                            # Build + push image
                            /kaniko/executor \
                              --context `pwd` \
                              --dockerfile `pwd`/Dockerfile \
                              --destination $REGISTRY/$IMAGE:$TAG \
                              --cache=true
                        '''
                    }
                }
            }
        }

        stage('Deploy GREEN') {
            steps {
                container('helm') {
                    withCredentials([file(credentialsId: 'kubeconfig-rancher', variable: 'KUBECONFIG')]) {
                        sh '''
                            set -e
                            export KUBECONFIG=$KUBECONFIG
                            kubectl config use-context rancher-desktop

                            helm upgrade --install $GREEN_RELEASE ./helm/django-app \
                              --set color=green \
                              --set image.repository=$REGISTRY/$IMAGE \
                              --set image.tag=$TAG \
                              --set serviceAccount.create=true
                        '''
                    }
                }
            }
        }

        stage('Wait for GREEN rollout') {
            steps {
                container('kubectl') {
                    withCredentials([file(credentialsId: 'kubeconfig-rancher', variable: 'KUBECONFIG')]) {
                        sh '''
                            set -e
                            export KUBECONFIG=$KUBECONFIG
                            kubectl config use-context rancher-desktop

                            kubectl rollout status deployment/${GREEN_RELEASE}-django-app --timeout=120s
                        '''
                    }
                }
            }
        }

        stage('Smoke test GREEN') {
            steps {
                container('kubectl') {
                    withCredentials([file(credentialsId: 'kubeconfig-rancher', variable: 'KUBECONFIG')]) {
                        sh '''
                            set -e
                            export KUBECONFIG=$KUBECONFIG
                            kubectl config use-context rancher-desktop

                            GREEN_SVC="${GREEN_RELEASE}-django-app"
                            IP=$(kubectl get svc $GREEN_SVC -o jsonpath='{.spec.clusterIP}')

                            STATUS=$(kubectl run smoke-test --rm -i --restart=Never \
                              --image=curlimages/curl:8.5.0 \
                              -- curl -s -o /dev/null -w "%{http_code}" http://$IP:8000/health/)

                            if [ "$STATUS" != "200" ]; then
                                echo "Smoke test FAILED"
                                exit 1
                            fi

                            echo "Smoke test PASSED"
                        '''
                    }
                }
            }
        }

        stage('Switch traffic to GREEN') {
            steps {
                container('kubectl') {
                    withCredentials([file(credentialsId: 'kubeconfig-rancher', variable: 'KUBECONFIG')]) {
                        sh '''
                            set -e
                            export KUBECONFIG=$KUBECONFIG
                            kubectl config use-context rancher-desktop

                            cp app/ingress-patch.json /tmp/ingress-patch.json
                            sed -i "s/REPLACE_HOST/$HOST/g" /tmp/ingress-patch.json
                            sed -i "s/REPLACE_SERVICE_NAME/${GREEN_RELEASE}-django-app/g" /tmp/ingress-patch.json

                            kubectl patch ingress django-app --type merge -p "$(cat /tmp/ingress-patch.json)"
                        '''
                    }
                }
            }
        }

        stage('Optional: Cleanup BLUE') {
            when { expression { false } }
            steps {
                container('helm') {
                    withCredentials([file(credentialsId: 'kubeconfig-rancher', variable: 'KUBECONFIG')]) {
                        sh '''
                            set -e
                            export KUBECONFIG=$KUBECONFIG
                            kubectl config use-context rancher-desktop
                            helm uninstall $BLUE_RELEASE || true
                        '''
                    }
                }
            }
        }
    }
}