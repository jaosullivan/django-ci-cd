pipeline {
    agent {
        kubernetes {
            yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
    - name: python
      image: python:3.12
      command: ['sleep']
      args: ['infinity']
      tty: true

    - name: kaniko
      image: gcr.io/kaniko-project/executor:debug
      command: ["/busybox/sh"]
      args: ["-c", "sleep infinity"]
      tty: true
"""
        }
    }

    environment {
        APP_NAME    = 'django-app'
        IMAGE_REPO  = 'ghcr.io/jaosullivan/django-app'

        GITOPS_REPO = 'https://github.com/jaosullivan/django-gitops.git'
        GITOPS_DIR  = 'django-gitops'
        CHART_PATH  = 'apps/django-app'

        SEMANTIC_TAG = 'dev'
    }

    parameters {
        booleanParam(name: 'PROMOTE', defaultValue: false, description: 'Promote dev â†’ blue/green')
        choice(name: 'TARGET_COLOR', choices: ['blue', 'green'], description: 'Which color to promote to')
    }

    stages {

        // ---------------------------------------------------------
        // Checkout
        // ---------------------------------------------------------
        stage('Checkout') {
            steps {
                container('python') {
                    sh '''
                      git config --global --add safe.directory /home/jenkins/agent/workspace/django-ci-cd
                    '''
                    checkout scm
                    script {
                        env.GIT_SHA = sh(
                            returnStdout: true,
                            script: 'git rev-parse --short HEAD'
                        ).trim()
                    }
                }
            }
        }

        // ---------------------------------------------------------
        // Tests + coverage
        // ---------------------------------------------------------
        stage('Test & Coverage') {
            steps {
                container('python') {
                    dir('projects/django-app') {
                        sh '''
                          set -e
                          pip install -r requirements.txt
                          pytest --maxfail=1 --disable-warnings
                          coverage report --fail-under=80
                        '''
                    }
                }
            }
        }

        // ---------------------------------------------------------
        // Build & push image with Kaniko
        // ---------------------------------------------------------
        stage('Build image (Kaniko)') {
            environment {
                DOCKER_CONFIG = '/kaniko/.docker'
            }
            steps {
                container('kaniko') {
                    withCredentials([string(credentialsId: 'ghcr-pat', variable: 'GHCR_PAT')]) {
                        sh '''
                          set -e
                          mkdir -p /kaniko/.docker

                          cat > /kaniko/.docker/config.json <<EOF
{
  "auths": {
    "ghcr.io": {
      "auth": "$(echo -n jaosullivan:${GHCR_PAT} | base64)"
    }
  }
}
EOF

                          /kaniko/executor \
                            --context ${WORKSPACE}/projects/django-app \
                            --dockerfile ${WORKSPACE}/projects/django-app/Dockerfile \
                            --destination ${IMAGE_REPO}:latest \
                            --destination ${IMAGE_REPO}:${GIT_SHA} \
                            --destination ${IMAGE_REPO}:${SEMANTIC_TAG} \
                            --cache=true
                        '''
                    }
                }
            }
        }

        // ---------------------------------------------------------
        // GitOps repo structure update (no image tags)
        // ---------------------------------------------------------
        stage('Update GitOps Repository (structure only)') {
            steps {
                container('python') {
                    withCredentials([usernamePassword(credentialsId: 'gitops-creds', usernameVariable: 'USER', passwordVariable: 'PASS')]) {
                        sh '''
                          set -e

                          wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
                          chmod +x /usr/local/bin/yq

                          rm -rf ${GITOPS_DIR}
                          git clone https://${USER}:${PASS}@github.com/jaosullivan/django-gitops.git ${GITOPS_DIR}
                          cd ${GITOPS_DIR}

                          git config user.email "ci@jenkins"
                          git config user.name "Jenkins CI"

                          git add .

                          if git diff --cached --quiet; then
                            echo "No structural changes"
                          else
                            git commit -m "Structural update (no image tags) ${GIT_SHA}"
                            git push
                          fi
                        '''
                    }
                }
            }
        }

        // ---------------------------------------------------------
        // PROMOTION: dev â†’ blue/green
        // ---------------------------------------------------------
        stage('Promote Image') {
            when { expression { return params.PROMOTE == true } }
            environment {
                GHCR = credentials('ghcr-pat')
            }
            steps {
                container('python') {
                    sh """
                        echo ${GHCR_PSW} | docker login ghcr.io -u ${GHCR_USR} --password-stdin

                        docker pull ${IMAGE_REPO}:${SEMANTIC_TAG}
                        docker tag ${IMAGE_REPO}:${SEMANTIC_TAG} ${IMAGE_REPO}:${TARGET_COLOR}
                        docker push ${IMAGE_REPO}:${TARGET_COLOR}
                    """
                }
            }
        }

        // ---------------------------------------------------------
        // HEALTH CHECK with automatic rollback trigger
        // ---------------------------------------------------------
        stage('Health Check New Color') {
            when { expression { return params.PROMOTE == true } }
            steps {
                container('python') {
                    script {
                        try {
                            sh """
                                echo "Waiting for deployment django-app-${TARGET_COLOR} to become ready..."

                                kubectl rollout status deployment/django-app-${TARGET_COLOR} \
                                    --namespace default \
                                    --timeout=120s
                            """
                        } catch (err) {
                            echo "âŒ Health check FAILED for ${TARGET_COLOR}. Triggering automatic rollback..."
                            currentBuild.result = 'FAILURE'
                            error("Health check failed â€” initiating rollback")
                        }
                    }
                }
            }
        }

        // ---------------------------------------------------------
        // SWITCH TRAFFIC (only if health check passed)
        // ---------------------------------------------------------
        stage('Switch Traffic (GitOps)') {
            when { expression { return params.PROMOTE == true && currentBuild.result != 'FAILURE' } }
            environment {
                GITOPS = credentials('gitops-creds')
            }
            steps {
                container('python') {
                    sh """
                        chmod +x ci/scripts/switch-color.sh
                        ./ci/scripts/switch-color.sh ${TARGET_COLOR}
                    """
                }
            }
        }

        // ---------------------------------------------------------
        // ARGO CD SYNC VERIFICATION
        // ---------------------------------------------------------
        stage('Argo CD Sync Verification') {
            when { expression { return params.PROMOTE == true && currentBuild.result != 'FAILURE' } }
            environment {
                ARGO = credentials('argocd-token')
            }
            steps {
                container('python') {
                    script {
                        try {
                            sh """
                                echo "ðŸ” Waiting for Argo CD to sync django-app..."

                                argocd app wait django-app \
                                  --auth-token ${ARGO_PSW} \
                                  --server argocd-server.argocd.svc.cluster.local \
                                  --grpc-web \
                                  --timeout 120 \
                                  --health \
                                  --sync
                            """

                            echo "âœ… Argo CD reports: Synced + Healthy"

                        } catch (err) {
                            echo "âŒ Argo CD sync verification FAILED. Triggering automatic rollback..."
                            currentBuild.result = 'FAILURE'
                            error("Argo CD sync failed â€” initiating rollback")
                        }
                    }
                }
            }
        }

        // ---------------------------------------------------------
        // SMOKE TEST (functional validation)
        // ---------------------------------------------------------
        stage('Smoke Test') {
            when { expression { return params.PROMOTE == true && currentBuild.result != 'FAILURE' } }
            steps {
                container('python') {
                    script {
                        try {
                            sh """
                                echo "ðŸš¦ Running smoke test against ${TARGET_COLOR} environment..."

                                curl -f http://django.local/health/ --max-time 10
                            """

                            echo "ðŸŸ¢ Smoke test passed"

                        } catch (err) {
                            echo "âŒ Smoke test FAILED. Triggering automatic rollback..."
                            currentBuild.result = 'FAILURE'
                            error("Smoke test failed â€” initiating rollback")
                        }
                    }
                }
            }
        }

        // ---------------------------------------------------------
        // AUTOMATIC ROLLBACK (health, ArgoCD, or smoke test failure)
        // ---------------------------------------------------------
        stage('Automatic Rollback') {
            when { expression { return params.PROMOTE == true && currentBuild.result == 'FAILURE' } }
            steps {
                container('python') {
                    script {
                        def rollbackColor = (params.TARGET_COLOR == 'blue') ? 'green' : 'blue'

                        echo "ðŸ”„ Rolling back traffic to ${rollbackColor}..."

                        sh """
                            chmod +x ci/scripts/switch-color.sh
                            ./ci/scripts/switch-color.sh ${rollbackColor}
                        """

                        echo "ðŸŸ¢ Rollback complete. Traffic restored to ${rollbackColor}."
                    }
                }
            }
        }
    }
}