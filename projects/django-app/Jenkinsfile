pipeline {
    agent {
        kubernetes {
            yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
    - name: python
      image: python:3.12
      command: ['sleep']
      args: ['infinity']
      tty: true

    - name: kaniko
      image: gcr.io/kaniko-project/executor:debug
      command: ["/busybox/sh"]
      args: ["-c", "sleep infinity"]
      tty: true
"""
        }
    }

    environment {
        APP_NAME    = 'django-app'
        IMAGE_REPO  = 'ghcr.io/jaosullivan/django-app'

        // GitOps repo details
        GITOPS_REPO = 'https://github.com/jaosullivan/django-gitops.git'
        GITOPS_DIR  = 'django-gitops'
        CHART_PATH  = 'apps/django-app'
    }

    stages {

        // ---------------------------------------------------------
        // Checkout application repo
        // ---------------------------------------------------------
        stage('Checkout') {
            steps {
                container('python') {

                    // Fix: allow Jenkins workspace for Git
                    sh '''
                      git config --global --add safe.directory /home/jenkins/agent/workspace/django-ci-cd
                    '''

                    checkout scm

                    script {
                        env.GIT_SHA = sh(
                            returnStdout: true,
                            script: 'git rev-parse --short HEAD'
                        ).trim()
                    }
                }
            }
        }

        // ---------------------------------------------------------
        // Tests + coverage gate
        // ---------------------------------------------------------
        stage('Test & Coverage') {
            steps {
                container('python') {
                    dir('projects/django-app') {
                        sh '''
                          set -e
                          pip install -r requirements.txt

                          # pytest.ini now controls coverage settings
                          pytest --maxfail=1 --disable-warnings

                          # Enforce coverage threshold
                          coverage report --fail-under=80
                        '''
                    }
                }
            }
        }

        // ---------------------------------------------------------
        // Build & push image with Kaniko
        // ---------------------------------------------------------
        stage('Build image (Kaniko)') {
            environment {
                DOCKER_CONFIG = '/kaniko/.docker'
            }
            steps {
                container('kaniko') {
                    withCredentials([string(credentialsId: 'ghcr-pat', variable: 'GHCR_PAT')]) {
                        sh '''
                          set -e
                          mkdir -p /kaniko/.docker

                          # FIX: Use HEREDOC to avoid JSON escaping issues
                          cat > /kaniko/.docker/config.json <<EOF
{
  "auths": {
    "ghcr.io": {
      "auth": "$(echo -n jaosullivan:${GHCR_PAT} | base64)"
    }
  }
}
EOF

                          /kaniko/executor \
                            --context ${WORKSPACE}/projects/django-app \
                            --dockerfile ${WORKSPACE}/projects/django-app/Dockerfile \
                            --destination ${IMAGE_REPO}:latest \
                            --destination ${IMAGE_REPO}:${GIT_SHA} \
                            --cache=true
                        '''
                    }
                }
            }
        }

        // ---------------------------------------------------------
        // Update GitOps repo (Deployment + Migration Job image tags)
        // ---------------------------------------------------------
        stage('Update GitOps Repository') {
            steps {
                container('python') {
                    withCredentials([usernamePassword(credentialsId: 'gitops-creds', usernameVariable: 'USER', passwordVariable: 'PASS')]) {
                        sh '''
                          set -e

                          # Install yq (Go version)
                          wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
                          chmod +x /usr/local/bin/yq

                          rm -rf ${GITOPS_DIR}
                          git clone https://${USER}:${PASS}@github.com/jaosullivan/django-gitops.git ${GITOPS_DIR}
                          cd ${GITOPS_DIR}

                          # Update Deployment image tag
                          yq -i '.image.tag = "${GIT_SHA}"' ${CHART_PATH}/values.yaml

                          # Update Migration Job image tag (FIX)
                          yq -i '.migrate.image.tag = "${GIT_SHA}"' ${CHART_PATH}/values.yaml

                          # Traffic routing via dynamic activeService
                          yq -i '.activeService = "django-app-default"' ${CHART_PATH}/values.yaml

                          git config user.email "ci@jenkins"
                          git config user.name "Jenkins CI"

                          git add .

                          if git diff --cached --quiet; then
                            echo "No changes to commit"
                          else
                            git commit -m "Deploy version ${GIT_SHA}"
                            git push
                          fi
                        '''
                    }
                }
            }
        }

        // ---------------------------------------------------------
        // Optional: Argo CD sync
        // ---------------------------------------------------------
        stage('Argo CD Sync (optional)') {
            when { expression { false } }
            steps {
                container('python') {
                    withCredentials([string(credentialsId: 'argocd-token', variable: 'ARGOCD_AUTH_TOKEN')]) {
                        sh '''
                          argocd app sync django-app \
                            --auth-token ${ARGOCD_AUTH_TOKEN} \
                            --server argocd-server.argocd.svc.cluster.local \
                            --grpc-web
                        '''
                    }
                }
            }
        }
    }
}