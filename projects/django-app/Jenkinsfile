pipeline {
    agent {
        kubernetes {
            defaultContainer 'k8s-tools'
            yaml '''
apiVersion: v1
kind: Pod
metadata:
  labels:
    jenkins/label: jenkins-jenkins-agent
spec:
  serviceAccountName: jenkins

  containers:
    - name: python
      image: python:3.12-slim
      command: ['cat']
      tty: true
      volumeMounts:
        - name: workspace-volume
          mountPath: /home/jenkins/agent

    - name: kaniko
      image: gcr.io/kaniko-project/executor:debug
      command: ['/busybox/sh']
      args: ['-c', 'sleep 9999999']
      tty: true
      volumeMounts:
        - name: workspace-volume
          mountPath: /home/jenkins/agent
        - name: kaniko-secret
          mountPath: /kaniko/.docker

    - name: k8s-tools
      image: dtzar/helm-kubectl:3.15.4
      command: ['cat']
      tty: true
      volumeMounts:
        - name: workspace-volume
          mountPath: /home/jenkins/agent

    - name: jnlp
      image: jenkins/inbound-agent:3355.v388858a_47b_33-12
      args: ['$(JENKINS_SECRET)', '$(JENKINS_NAME)']
      volumeMounts:
        - name: workspace-volume
          mountPath: /home/jenkins/agent

  volumes:
    - name: workspace-volume
      emptyDir: {}
    - name: kaniko-secret
      emptyDir: {}
'''
        }
    }

    environment {
        REGISTRY = "ghcr.io/jaosullivan"
        IMAGE    = "django-app"
        TAG      = "latest"

        # GitOps repo
        GITOPS_REPO = "github.com/jaosullivan/django-gitops.git"
        GITOPS_DIR  = "django-gitops"

        COVERAGE_FAIL_UNDER = "80"
    }

    stages {

        stage('Checkout') {
            steps { checkout scm }
        }

        stage('Determine Version Tag') {
            steps {
                container('k8s-tools') {
                    sh '''
                        set -e
                        git config --global --add safe.directory $(pwd)
                        COMMIT=$(git rev-parse --short HEAD)
                        echo $COMMIT > commit.txt
                    '''
                }
                script {
                    env.COMMIT = readFile('commit.txt').trim()
                    echo "Using image tag: ${env.COMMIT}"
                }
            }
        }

        stage('Run Unit Tests (pytest + coverage)') {
            steps {
                container('python') {
                    sh '''
                        set -e
                        export PYTHONPATH=$PYTHONPATH:$(pwd)/projects/django-app
                        pip install -r projects/django-app/requirements.txt
                        coverage run -m pytest
                        coverage report --fail-under=$COVERAGE_FAIL_UNDER
                    '''
                }
            }
        }

        stage('Build image (Kaniko)') {
            steps {
                container('kaniko') {
                    withCredentials([string(credentialsId: 'ghcr-pat', variable: 'GHCR_PAT')]) {
                        sh '''
                            set -e

                            mkdir -p /kaniko/.docker
                            cat <<EOF > /kaniko/.docker/config.json
                            {
                              "auths": {
                                "ghcr.io": {
                                  "auth": "$(echo -n ${REGISTRY#*/}:$GHCR_PAT | base64)"
                                }
                              }
                            }
EOF

                            /kaniko/executor \
                              --context `pwd`/projects/django-app \
                              --dockerfile `pwd`/projects/django-app/Dockerfile \
                              --destination $REGISTRY/$IMAGE:$TAG \
                              --destination $REGISTRY/$IMAGE:$COMMIT \
                              --cache=true
                        '''
                    }
                }
            }
        }

        stage('Update GitOps Repository') {
            steps {
                container('k8s-tools') {
                    withCredentials([usernamePassword(credentialsId: 'gitops-creds', usernameVariable: 'USER', passwordVariable: 'PASS')]) {
                        sh '''
                            set -e

                            rm -rf $GITOPS_DIR
                            git clone https://$USER:$PASS@$GITOPS_REPO $GITOPS_DIR

                            cd $GITOPS_DIR

                            # Update GREEN image tag
                            sed -i "s/tag:.*/tag: $COMMIT/" apps/django-app/green/values-green.yaml

                            # Switch ingress to GREEN
                            sed -i "s/name:.*/name: django-green-django-app-green/" clusters/production/ingress.yaml

                            git config user.email "ci@jenkins"
                            git config user.name "Jenkins CI"

                            git add .
                            git commit -m "Deploy version $COMMIT"
                            git push
                        '''
                    }
                }
            }
        }
    }
}