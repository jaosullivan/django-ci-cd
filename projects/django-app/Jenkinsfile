pipeline {
    agent {
        kubernetes {
            yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
    - name: python
      image: python:3.12-slim
      command: ['sleep']
      args: ['infinity']
      tty: true

    - name: kaniko
      image: gcr.io/kaniko-project/executor:latest
      command: ['sleep']
      args: ['infinity']
      tty: true
"""
        }
    }

    environment {
        APP_NAME    = 'django-app'
        IMAGE_REPO  = 'ghcr.io/jaosullivan/django-app'

        // GitOps repo details
        GITOPS_REPO = 'https://github.com/jaosullivan/django-gitops.git'
        GITOPS_DIR  = 'django-gitops'
        CHART_PATH  = 'apps/django-app'
    }

    stages {

        // ---------------------------------------------------------
        // Checkout application repo
        // ---------------------------------------------------------
        stage('Checkout') {
            steps {
                container('python') {
                    checkout scm
                    script {
                        env.GIT_SHA = sh(
                            returnStdout: true,
                            script: 'git rev-parse --short HEAD'
                        ).trim()
                    }
                }
            }
        }

        // ---------------------------------------------------------
        // Tests + coverage gate
        // ---------------------------------------------------------
        stage('Test & Coverage') {
            steps {
                container('python') {
                    dir('projects/django-app') {
                        sh '''
                          set -e
                          pip install -r requirements.txt
                          pytest --maxfail=1 --disable-warnings --cov=projects/django-app --cov-report=term-missing
                          coverage report --fail-under=80
                        '''
                    }
                }
            }
        }

        // ---------------------------------------------------------
        // Build & push image with Kaniko
        // ---------------------------------------------------------
        stage('Build image (Kaniko)') {
            environment {
                DOCKER_CONFIG = '/kaniko/.docker'
            }
            steps {
                container('kaniko') {
                    withCredentials([string(credentialsId: 'ghcr-pat', variable: 'GHCR_PAT')]) {
                        sh '''
                          set -e
                          mkdir -p /kaniko/.docker
                          echo "{\"auths\":{\"ghcr.io\":{\"auth\":\"$(echo -n jaosullivan:${GHCR_PAT} | base64)\"}}}" > /kaniko/.docker/config.json

                          /kaniko/executor \
                            --context ${WORKSPACE}/projects/django-app \
                            --dockerfile ${WORKSPACE}/projects/django-app/Dockerfile \
                            --destination ${IMAGE_REPO}:latest \
                            --destination ${IMAGE_REPO}:${GIT_SHA} \
                            --cache=true
                        '''
                    }
                }
            }
        }

        // ---------------------------------------------------------
        // Update GitOps repo (image tag + activeService)
        // ---------------------------------------------------------
        stage('Update GitOps Repository') {
            steps {
                container('python') {
                    withCredentials([usernamePassword(credentialsId: 'github-https', usernameVariable: 'USER', passwordVariable: 'PASS')]) {
                        sh '''
                          set -e

                          rm -rf ${GITOPS_DIR}
                          git clone https://${USER}:${PASS}@github.com/jaosullivan/django-gitops.git ${GITOPS_DIR}
                          cd ${GITOPS_DIR}

                          # Update image tag in main values.yaml
                          yq -i '.image.tag = "${GIT_SHA}"' ${CHART_PATH}/values.yaml

                          # Traffic routing via dynamic activeService
                          # Options: "django-app-default", "django-app-blue", "django-app-green"
                          yq -i '.activeService = "django-app-default"' ${CHART_PATH}/values.yaml

                          git config user.email "ci@jenkins"
                          git config user.name "Jenkins CI"

                          git add .

                          if git diff --cached --quiet; then
                            echo "No changes to commit"
                          else
                            git commit -m "Deploy version ${GIT_SHA}"
                            git push
                          fi
                        '''
                    }
                }
            }
        }

        // ---------------------------------------------------------
        // Optional: Argo CD sync
        // ---------------------------------------------------------
        stage('Argo CD Sync (optional)') {
            when { expression { false } } // set to true if you want Jenkins to trigger sync
            steps {
                container('python') {
                    withCredentials([string(credentialsId: 'argocd-token', variable: 'ARGOCD_AUTH_TOKEN')]) {
                        sh '''
                          argocd app sync django-app \
                            --auth-token ${ARGOCD_AUTH_TOKEN} \
                            --server argocd-server.argocd.svc.cluster.local \
                            --grpc-web
                        '''
                    }
                }
            }
        }
    }
}